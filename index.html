<!doctype html>
<html lang="bn">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SecretGPT</title>
  <style>
    :root{--brand:#1363DF;--muted:#666}
    body{font-family:system-ui, -apple-system, "Noto Sans Bengali", sans-serif; margin:18px; max-width:900px;}
    h1{font-size:1.3rem;margin-bottom:6px;}
    textarea{width:100%;height:160px;padding:10px;border-radius:8px;border:1px solid #ddd;resize:vertical}
    input[type="text"], input[type="password"]{width:100%;padding:8px;border-radius:8px;border:1px solid #ddd}
    .row{display:flex;gap:10px;margin-top:10px;flex-wrap:wrap}
    button{padding:8px 12px;border-radius:8px;border:0;background:var(--brand);color:#fff;cursor:pointer}
    .muted{color:var(--muted);font-size:0.95rem;margin-top:8px}
    pre{white-space:pre-wrap;background:#f7f7f7;padding:10px;border-radius:8px;border:1px solid #eee}
    .linkbox{display:flex;gap:8px;align-items:center;margin-top:10px;flex-wrap:wrap}
    .small{font-size:0.9rem;padding:6px 8px;border-radius:6px;border:1px solid #ddd;background:#fff}
    .danger{background:#D64545}
    .flex-between{display:flex;justify-content:space-between;align-items:center}
    footer{margin-top:18px;color:var(--muted);font-size:0.9rem}
  </style>

  <!-- Libraries -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lz-string/1.4.4/lz-string.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
</head>
<body>
	<center>
  <h1>SecretGPT</h1>
  <div class="muted">আপনি ChatGPT কনভারসেশন বা লিংক পেস্ট করুন এরপর চাইলে পাসওয়ার্ড দিয়ে সুরক্ষিত করুন। তারপর "Create share link" এ ক্লিক করুন — যে কেউ ওই লিংক খুললে কনটেন্ট দেখতে পাবে (পাসওয়ার্ড থাকলে সেটা দিতে হবে)।</div>

  <label style="margin-top:12px;display:block">লিংকের শিরোনাম (ঐচ্ছিক)</label>
  <input id="title" placeholder="Conversation title (optional)" type="text">

  <label style="margin-top:10px;display:block">Conversation (paste here)</label>
  <textarea id="conv" placeholder="এখানে আপনার চ্যাট কপি/পেস্ট করুন — প্রতিটি মেসেজ, প্রশ্ন/উত্তর/ লিংক ইত্যাদি।"></textarea>

  <label style="margin-top:10px;display:block">Password (ঐচ্ছিক) — লিংক পাসওয়ার্ড দিয়ে সুরক্ষিত হবে</label>
  <input id="password" placeholder="ফাঁকা রাখলে পাসওয়ার্ড থাকবে না" type="password">

  <div class="row">
    <button id="make">Create share link</button>
    <button id="clear" class="small">Clear</button>
    <button id="download" class="small">Download .json</button>
    <button id="copyConv" class="small">Copy decoded content</button>
  </div>

  <div class="linkbox" id="result" style="display:none">
    <input id="sharelink" readonly style="min-width:260px;padding:8px;border-radius:6px;border:1px solid #ddd">
    <button id="copyLink" class="small">Copy link</button>
    <button id="openLink" class="small">Open</button>
    <button id="shareAPI" class="small">Share (Web Share)</button>
    <button id="genQR" class="small">Show QR</button>
  </div>

  <div id="qrcode" style="margin-top:12px;"></div>

  <h3 style="margin-top:18px">Decoded preview</h3>
  <pre id="preview">কোনো কনভারসেশন নেই</pre>

  <footer>
  	<center>
    <div><strong>নোট:</strong> আপনার ব্যক্তিগত কনভারসেশন সার্ভার সাইট হতে সম্পূর্ণ নিরাপদ ও সুরক্ষিত। </div>
    <p> Humayun Shariar Himu </p>
    </center>
  </footer>

<script>
(function(){
  const convEl = document.getElementById('conv');
  const titleEl = document.getElementById('title');
  const passEl = document.getElementById('password');
  const makeBtn = document.getElementById('make');
  const clearBtn = document.getElementById('clear');
  const resultBox = document.getElementById('result');
  const shareLinkEl = document.getElementById('sharelink');
  const copyLinkBtn = document.getElementById('copyLink');
  const openLinkBtn = document.getElementById('openLink');
  const preview = document.getElementById('preview');
  const copyConvBtn = document.getElementById('copyConv');
  const downloadBtn = document.getElementById('download');
  const shareAPIBtn = document.getElementById('shareAPI');
  const genQRBtn = document.getElementById('genQR');
  const qrcodeDiv = document.getElementById('qrcode');

  // Helper: AES encrypt/decrypt with CryptoJS
  function encryptAES(text, pass){
    return CryptoJS.AES.encrypt(text, pass).toString();
  }
  function decryptAES(ciphertext, pass){
    try{
      const bytes = CryptoJS.AES.decrypt(ciphertext, pass);
      const txt = bytes.toString(CryptoJS.enc.Utf8);
      return txt || null;
    }catch(e){ return null; }
  }

  function makeShareLink(obj, password){
    let payload = JSON.stringify(obj);
    if(password){
      payload = JSON.stringify({__enc: true, data: encryptAES(payload, password)});
    }
    const compressed = LZString.compressToEncodedURIComponent(payload);
    return location.origin + location.pathname + '#data=' + compressed;
  }

  function decodeFromHash(hash){
    if(!hash) return null;
    const m = hash.match(/data=([^&]+)/);
    if(!m) return null;
    try{
      const compressed = m[1];
      const payload = LZString.decompressFromEncodedURIComponent(compressed);
      if(!payload) return null;
      // check if encrypted wrapper
      const obj = JSON.parse(payload);
      return obj;
    }catch(e){
      return null;
    }
  }

  function showPreviewText(text){
    preview.textContent = text || 'কোনো কনভারসেশন নেই';
  }

  makeBtn.addEventListener('click', ()=>{
    const content = convEl.value.trim();
    if(!content){ alert('আগে কনভারসেশন পেস্ট করুন।'); return; }
    const obj = { title: titleEl.value.trim(), content, created_at: new Date().toISOString() };
    const pass = passEl.value || '';
    const link = makeShareLink(obj, pass || null);
    shareLinkEl.value = link;
    resultBox.style.display = 'flex';
    showPreviewText((obj.title ? obj.title + "\n\n" : '') + obj.content);

    // update location.hash for current page
    try {
      const compressed = LZString.compressToEncodedURIComponent(pass ? JSON.stringify({__enc:true,data:encryptAES(JSON.stringify(obj),pass)}) : JSON.stringify(obj));
      location.hash = 'data=' + compressed;
    } catch(e){}
  });

  clearBtn.addEventListener('click', ()=>{
    convEl.value = ''; titleEl.value = ''; passEl.value = '';
    showPreviewText('কোনো কনভারসেশন নেই');
    resultBox.style.display = 'none'; qrcodeDiv.innerHTML = '';
    history.replaceState(null, '', location.pathname); // remove hash
  });

  copyLinkBtn.addEventListener('click', async ()=>{
    try{
      await navigator.clipboard.writeText(shareLinkEl.value);
      copyLinkBtn.textContent = 'Copied!';
      setTimeout(()=> copyLinkBtn.textContent = 'Copy link', 1500);
    }catch(e){ alert('Copy failed — use manual copy.'); }
  });

  openLinkBtn.addEventListener('click', ()=> {
    window.open(shareLinkEl.value, '_blank');
  });

  copyConvBtn.addEventListener('click', async ()=>{
    const h = location.hash;
    const obj = decodeFromHash(h);
    if(!obj){ alert('কোনো ডিকোডেবল কনভারসেশন নেই।'); return; }

    // if encrypted, ask for password
    if(obj.__enc){
      const pw = prompt('This link is password protected. Enter password:');
      if(!pw){ alert('Password required.'); return; }
      const dec = decryptAES(obj.data, pw);
      if(!dec){ alert('Incorrect password or corrupted data.'); return; }
      const parsed = JSON.parse(dec);
      try{
        await navigator.clipboard.writeText(parsed.content || '');
        copyConvBtn.textContent = 'Copied!';
        setTimeout(()=> copyConvBtn.textContent = 'Copy decoded content', 1500);
      }catch(e){ alert('Copy failed.'); }
      return;
    }

    try{
      await navigator.clipboard.writeText(obj.content || '');
      copyConvBtn.textContent = 'Copied!';
      setTimeout(()=> copyConvBtn.textContent = 'Copy decoded content', 1500);
    }catch(e){ alert('Copy failed.'); }
  });

  downloadBtn.addEventListener('click', ()=>{
    const content = convEl.value.trim();
    if(!content){ alert('কনভারসেশন নেই।'); return; }
    const obj = { title: titleEl.value.trim(), content, created_at: new Date().toISOString() };
    const blob = new Blob([JSON.stringify(obj, null, 2)], {type:'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = (obj.title ? obj.title.replace(/\s+/g,'_') : 'conversation') + '.json';
    document.body.appendChild(a); a.click(); a.remove();
    URL.revokeObjectURL(url);
  });

  shareAPIBtn.addEventListener('click', async ()=>{
    const link = shareLinkEl.value || location.href;
    if(navigator.share){
      try{
        await navigator.share({title: titleEl.value || 'Shared Conversation', text: 'Open this conversation', url: link});
      }catch(e){}
    }else{
      alert('Web Share API supported নেই আপনার ব্রাউজারে — কপিতে ক্লিক করুন।');
    }
  });

  genQRBtn.addEventListener('click', ()=>{
    const url = shareLinkEl.value || location.href;
    if(!url){ alert('প্রথমে লিংক তৈরি করুন।'); return; }
    qrcodeDiv.innerHTML = '';
    new QRCode(qrcodeDiv, { text: url, width: 180, height: 180 });
  });

  // on load: if hash present, decode & show
  document.addEventListener('DOMContentLoaded', ()=>{
    const obj = decodeFromHash(location.hash);
    if(!obj) return;
    // if encrypted, prompt for password to show content
    if(obj.__enc){
      const pw = prompt('এই লিংক পাসওয়ার্ড-প্রটেক্ট করা আছে। পাসওয়ার্ড লিখুন (বাতিল করতে Cancel চাপুন):');
      if(!pw){
        showPreviewText('এই লিংকটি পাসওয়ার্ড-প্রটেক্টেড। কনটেন্ট দেখতে পাসওয়ার্ড দিন।');
        // still show partial (title masked)
        shareLinkEl.value = location.href;
        resultBox.style.display = 'flex';
        return;
      }
      const dec = decryptAES(obj.data, pw);
      if(!dec){
        showPreviewText('পাসওয়ার্ড ভুল অথবা ডাটা ক্ষতিগ্রস্ত।');
        shareLinkEl.value = location.href;
        resultBox.style.display = 'flex';
        return;
      }
      const parsed = JSON.parse(dec);
      titleEl.value = parsed.title || '';
      convEl.value = parsed.content || '';
      showPreviewText((parsed.title ? parsed.title + "\n\n" : '') + (parsed.content || ''));
      shareLinkEl.value = location.href;
      resultBox.style.display = 'flex';
      return;
    }
    // not encrypted
    titleEl.value = obj.title || '';
    convEl.value = obj.content || '';
    showPreviewText((obj.title ? obj.title + "\n\n" : '') + (obj.content || ''));
    shareLinkEl.value = location.href;
    resultBox.style.display = 'flex';
  });
})();
</script>
</center>
</body>
</html>
